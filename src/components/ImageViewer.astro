<!-- 图片查看器组件 -->
<div
  id="image-viewer"
  class="image-viewer hidden"
  role="dialog"
  aria-modal="true"
  aria-label="图片查看器"
  aria-hidden="true"
>
  <div class="image-viewer-backdrop" aria-hidden="true"></div>
  <div class="image-viewer-content">
    <button
      id="close-viewer"
      class="close-button"
      aria-label="关闭图片查看器"
      type="button"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="size-6"
        aria-hidden="true"
      >
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <img id="viewer-image" src="" alt="" loading="lazy" />
  </div>
</div>

<style>
  .image-viewer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .image-viewer.show {
    opacity: 1;
  }

  .image-viewer.hidden {
    display: none;
  }

  .image-viewer-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    cursor: pointer;
  }

  .image-viewer-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    z-index: 10000;
  }

  .close-button {
    position: absolute;
    top: -50px;
    right: 0;
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px;
    transition: all 0.2s;
    border-radius: 9999px;
    z-index: 10001;
    background-color: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(4px);
  }

  .close-button:hover {
    background-color: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
  }

  .close-button:focus-visible {
    outline: 2px solid white;
    outline-offset: 2px;
  }

  #viewer-image {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  }
</style>

<script>
  function setupImageViewer() {
    const viewer = document.getElementById("image-viewer");
    const viewerImage = document.getElementById(
      "viewer-image",
    ) as HTMLImageElement | null;
    const closeButton = document.getElementById("close-viewer");
    const backdrop = document.querySelector(".image-viewer-backdrop");

    if (!viewer || !viewerImage) return;

    // Zoom and Pan state
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;

    const updateTransform = () => {
      viewerImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    };

    const resetZoom = () => {
      scale = 1;
      translateX = 0;
      translateY = 0;
      updateTransform();
      viewerImage.style.cursor = "grab";
    };

    // 为文章中的所有图片添加点击事件
    const articleImages = document.querySelectorAll("article img");

    articleImages.forEach((img) => {
      const imageElement = img as HTMLImageElement;
      imageElement.style.cursor = "pointer";
      imageElement.setAttribute("role", "button");
      imageElement.setAttribute("tabindex", "0");
      imageElement.setAttribute(
        "aria-label",
        `查看大图: ${imageElement.alt || "图片"}`,
      );

      const openViewer = () => {
        viewerImage.src = imageElement.src;
        viewerImage.alt = imageElement.alt;
        resetZoom(); // Reset zoom state when opening
        viewer.classList.remove("hidden");
        viewer.setAttribute("aria-hidden", "false");
        // 使用 setTimeout 确保过渡动画生效
        setTimeout(() => {
          viewer.classList.add("show");
        }, 10);
        // 防止页面滚动
        document.body.style.overflow = "hidden";
        // 设置焦点到关闭按钮
        closeButton?.focus();
      };

      imageElement.addEventListener("click", openViewer);

      // 键盘可访问性
      imageElement.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openViewer();
        }
      });
    });

    // 关闭查看器的函数
    const closeViewer = () => {
      viewer.classList.remove("show");
      viewer.setAttribute("aria-hidden", "true");
      setTimeout(() => {
        viewer.classList.add("hidden");
        document.body.style.overflow = "";
        viewerImage.src = "";
        resetZoom(); // Reset zoom state when closing
      }, 300);
    };

    // Zoom handler
    viewerImage.addEventListener("wheel", (e) => {
      if (!e.ctrlKey) return;
      e.preventDefault();
      const delta = -Math.sign(e.deltaY) * 0.1;
      const newScale = Math.min(Math.max(0.1, scale + delta), 5); // Limit zoom level
      scale = newScale;
      updateTransform();
    });

    // Pan (Drag) handlers
    viewerImage.addEventListener("mousedown", (e) => {
      e.preventDefault();
      isDragging = true;
      startX = e.clientX - translateX;
      startY = e.clientY - translateY;
      viewerImage.style.cursor = "grabbing";
    });

    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      e.preventDefault();
      translateX = e.clientX - startX;
      translateY = e.clientY - startY;
      updateTransform();
    });

    window.addEventListener("mouseup", () => {
      if (isDragging) {
        isDragging = false;
        viewerImage.style.cursor = "grab";
      }
    });

    // 点击关闭按钮
    closeButton?.addEventListener("click", closeViewer);

    // 点击背景关闭
    backdrop?.addEventListener("click", closeViewer);

    // 按 ESC 键关闭
    const handleKeydown = (e: KeyboardEvent) => {
      if (e.key === "Escape" && !viewer.classList.contains("hidden")) {
        closeViewer();
      }
    };
    document.addEventListener("keydown", handleKeydown);
  }

  // 初始化
  setupImageViewer();

  // Astro 页面切换后重新初始化
  document.addEventListener("astro:after-swap", setupImageViewer);
</script>
